# Design: LLM Data Accuracy Enhancement

## Context

当前系统将所有 GA4 和 Search Console 数据合并成一个大 JSON 对象发送给 Gemini 进行分析。随着数据量增加，LLM 可能出现：
1. **数据混淆**：将 A 关键词的数据错误归结到 B 关键词
2. **时间混淆**：混淆当前周期和前一周期的数据
3. **来源混淆**：混淆 GA4 和 Search Console 数据
4. **上下文丢失**：在长上下文中丢失前面的数据细节

## Goals

- 减少 LLM 数据混淆错误至可接受水平
- 提供数据引用追溯能力
- 保持系统简单性，避免过度工程化
- 确保报告的可验证性

## Non-Goals

- 不追求 100% 准确（LLM 本身存在随机性）
- 不引入复杂的多步骤对话流程
- 不改变现有数据获取逻辑

## Decisions

### 决策 1: 使用结构化表格替代 JSON

**选择**: 在 prompt 中使用 Markdown 表格展示数据而非 JSON

**原因**:
- 表格格式更清晰地表达行列关系
- 减少 LLM 解析 JSON 时的认知负担
- 更易于添加行级唯一标识

**示例**:
```markdown
### GA4 关键词数据
| ID | 关键词 | 点击 | 展示 | 排名 |
|----|--------|------|------|------|
| KW001 | example keyword | 100 | 5000 | 4.2 |
| KW002 | another keyword | 50 | 3000 | 8.5 |
```

### 决策 2: 数据分段处理

**选择**: 将大数据分成多个逻辑段落，每段有明确边界标记

**原因**:
- 避免单次处理过多信息
- 边界标记帮助 LLM 明确数据范围
- 便于后续引用追溯

**实现**: 使用 HTML 注释作为边界标记（不影响 Markdown 渲染）

### 决策 3: 强制数据引用标注

**选择**: 在 prompt 中要求 LLM 对每个数据结论标注来源

**原因**:
- 减少"幻觉"生成
- 提供可验证性
- 帮助 LLM 在生成时"锚定"到具体数据

### 决策 4: 保持单次请求架构

**选择**: 不拆分为多次 API 调用，保持单次请求

**原因**:
- 保持系统简单
- 避免多次调用的延迟和成本
- 对于当前数据量，单次请求足够

**备选方案（放弃）**: 多次调用分别分析不同维度再合并——过于复杂，当前不需要

## Risks / Trade-offs

| 风险 | 缓解措施 |
|------|----------|
| 表格格式增加 prompt 长度 | 控制数据量限制，保持 top N 记录 |
| 引用标注可能被 LLM 忽略 | 在 prompt 中使用 few-shot 示例强化 |
| 边界标记可能被误解 | 使用 HTML 注释格式避免冲突 |

## Migration Plan

1. 修改 prompt 模板以使用新格式
2. 修改 analyzer 将 JSON 转换为表格
3. 添加验证 footer 展示原始数据摘要
4. 测试并验证报告质量

## Open Questions

- 是否需要添加自动化的数据校验？（建议后续迭代）
- 数据量阈值是多少时需要考虑拆分请求？（建议 > 100 条记录时）
